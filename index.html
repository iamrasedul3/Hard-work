<!-- Monetag SDK -->
    <script src='//libtl.com/sdk.js' data-zone='9867756' data-sdk='show_9867756'></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            const userData = tg.initDataUnsafe.user;

            const navItems = document.querySelectorAll('.nav-item');
            const pages = document.querySelectorAll('.page');
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const startEarningBtn = document.getElementById('start-earning-btn');
            const withdrawBtn = document.getElementById('withdraw-btn');
            const withdrawForm = document.getElementById('withdraw-form');

            const DAILY_ADS_LIMIT = 50;
            const AD_REWARD = 0.02; // BDT per ad
            const MIN_WITHDRAW_AMOUNT = 100;

            if (!localStorage.getItem('earnings')) {
                localStorage.setItem('earnings', '0');
                localStorage.setItem('adsWatched', '0');
                localStorage.setItem('totalReferrals', '0');
            }

            function updateUI() {
                const earnings = parseFloat(localStorage.getItem('earnings'));
                const adsWatched = parseInt(localStorage.getItem('adsWatched'));
                const referrals = parseInt(localStorage.getItem('totalReferrals'));

                const formattedEarnings = earnings.toFixed(2);

                document.getElementById('current-balance').textContent = `BDT ${formattedEarnings}`;
                document.getElementById('total-earnings').textContent = `BDT ${formattedEarnings}`;
                document.getElementById('ads-watched').textContent = adsWatched;
                document.getElementById('total-referrals').textContent = referrals;

                document.getElementById('ad-progress-text').textContent = `Completed: ${adsWatched} / ${DAILY_ADS_LIMIT}`;
                const progress = (adsWatched / DAILY_ADS_LIMIT) * 100;
                document.getElementById('ad-progress-bar').style.width = `${progress}%`;

                watchAdBtn.disabled = adsWatched >= DAILY_ADS_LIMIT;
            }

            function showPage(targetPageId) {
                navItems.forEach(nav => nav.classList.remove('active'));
                pages.forEach(page => page.classList.remove('active'));

                const activeNavItem = document.querySelector(`[data-page="${targetPageId}"]`);
                if (activeNavItem) activeNavItem.classList.add('active');

                const activePage = document.getElementById(targetPageId);
                if (activePage) activePage.classList.add('active');
            }

            navItems.forEach(item => {
                item.addEventListener('click', () => showPage(item.getAttribute('data-page')));
            });

            startEarningBtn.addEventListener('click', () => showPage('earn-page'));
            withdrawBtn.addEventListener('click', () => showPage('withdraw-page'));

            // ====== Watch Ad Button ======
            watchAdBtn.addEventListener('click', () => {
                if (parseInt(localStorage.getItem('adsWatched')) >= DAILY_ADS_LIMIT) {
                    tg.showAlert('আপনার দৈনিক বিজ্ঞাপনের সীমা পৌঁছে গেছে।');
                    return;
                }

                watchAdBtn.disabled = true;

                // Rewarded interstitial
                show_9867756().then(() => {
                    let earnings = parseFloat(localStorage.getItem('earnings')) + AD_REWARD;
                    let currentAdsWatched = parseInt(localStorage.getItem('adsWatched')) + 1;

                    localStorage.setItem('earnings', earnings.toString());
                    localStorage.setItem('adsWatched', currentAdsWatched.toString());

                    tg.showAlert(`বিজ্ঞাপনটি দেখার জন্য আপনি BDT ${AD_REWARD.toFixed(2)} পেয়েছেন!`);
                }).catch(() => {
                    tg.showAlert('বিজ্ঞাপনটি দেখাতে সমস্যা হয়েছে। আবার চেষ্টা করুন।');
                }).finally(() => {
                    updateUI();
                    watchAdBtn.disabled = false;
                });
            });

            // ====== Rewarded Popup (auto trigger example) ======
            // show_9867756('pop').then(() => {
            //     console.log('Popup ad watched');
            // }).catch(e => {});

            // ====== In-App Interstitial (auto show example) ======
            // show_9867756({
            //   type: 'inApp',
            //   inAppSettings: {
            //     frequency: 2,
            //     capping: 0.1,
            //     interval: 30,
            //     timeout: 5,
            //     everyPage: false
            //   }
            // });

            withdrawForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('withdraw-amount').value);

                tg.showConfirm(`আপনি কি আপনার উইথড্র অনুরোধ জমা দিতে চান?`, (confirmed) => {
                    if (confirmed) {
                        let newEarnings = parseFloat(localStorage.getItem('earnings')) - amount;
                        localStorage.setItem('earnings', newEarnings.toString());

                        tg.showAlert('আপনার উইথড্র অনুরোধ সফলভাবে জমা হয়েছে।');
                        withdrawForm.reset();
                        updateUI();
                    }
                });
            });

            updateUI();
        });
    </script>